include required(classpath("application"))

# Call caching lookups can be slow, and are not relevant to the function of the backend
call-caching.enabled = false

akka {
  actor.default-dispatcher.fork-join-executor {
    parallelism-factor = 100.0
    parallelism-max = 64
  }

  # Optionally set / override any akka settings
  http {
    server {
      # Increasing these timeouts allow rest api responses for very large jobs
      # to be returned to the user. When the timeout is reached the server would respond
      # `The server was not able to produce a timely response to your request.`
      # https://gatkforums.broadinstitute.org/wdl/discussion/10209/retrieving-metadata-for-large-workflows
      request-timeout = 10m
      # idle-timeout = 20s
    }
  }

  http.host-connection-pool.max-open-requests = 16384
  http.host-connection-pool.max-connections = 2000
}

system {
  job-rate-control {
    jobs = 20
    per = 10 seconds
  }

  max-workflow-launch-count = 1
  new-workflow-poll-rate = 1
  max-concurrent-workflows = 12500
  number-of-cache-read-workers = 50

  io {
    # Throttle for GCS calls.
    throttle {
      # Adjust to match quota
      number-of-requests = 10240611
      per = 100 seconds
    }
  }
}

google {
  application-name = "cromwell"
  auths = [
    {
      name = "application-default"
      scheme = "application_default"
    }
  ]
}

engine {
  filesystems {
    gcs {
      auth = "application-default"
      project = "batch-testing-350715"
    }
  }
}

backend {
  default = batch
  providers {
    batch {
      actor-factory = "cromwell.backend.google.batch.GcpBatchBackendLifecycleActorFactory"
      config {
        // Google project
        project = "batch-testing-350715"

        // Base bucket for workflow executions
        root = "gs://cromwell-29292/cromwell-execution"

        // dockers entry point
        job-shell = "/bin/sh"

        use_reference_disks = false

        // Polling for completion backs-off gradually for slower-running jobs.
        // This is the maximum polling interval (in seconds):
        maximum-polling-interval = 600

        request-workers = 3


        virtual-private-cloud {
           network-name =  "projects/batch-testing-350715/global/networks/my-custom-network"
           subnetwork-name = "projects/batch-testing-350715/regions/us-central1/subnetworks/central2-subnet"
        }

        genomics {
          // A reference to an auth defined in the `google` stanza at the top.  This auth is used to create
          // Pipelines and manipulate auth JSONs.
          auth = "application-default"

          // Endpoint for APIs, which defaults to us-central1. To run with a location different from us-central1,
          // change the endpoint-url to start with the location, such as https://europe-west2-lifesciences.googleapis.com/
          endpoint-url = "https://lifesciences.googleapis.com/"

          // This allows you to use an alternative service account to launch jobs, by default uses default service account
          compute-service-account = "default"

          // Cloud Life Sciences API is limited to certain locations. See https://cloud.google.com/life-sciences/docs/concepts/locations
          // and note that changing the location also requires changing the endpoint-url.
          location = "us-central1"

          // Pipelines v2 only: specify the number of times localization and delocalization operations should be attempted
          // There is no logic to determine if the error was transient or not, everything is retried upon failure
          // Defaults to 3
          localization-attempts = 3
        }

        filesystems {
          gcs {
            // A reference to a potentially different auth for manipulating files via engine functions.
            auth = "application-default"
            project = "batch-testing-350715"
          }
        }
      }
    }
  }
}

# Make sure the WDL parsing cache is on
languages {

  WDL {
    http-allow-list {
      enabled: false
    }

    versions {
      "draft-2" {
        config.caching {
          enabled: true
          ttl: 5 seconds
          size: 100
          concurrency: 9
        }
      }

      "1.0" {
        config.caching {
          enabled: true
          ttl: 5 seconds
          size: 100
          concurrency: 9
        }
      }
    }
  }
}

load-control {
  job-store-read = 10000
  job-store-write = 10000

  call-cache-read = 1000
  call-cache-write = 10000

  key-value-read = 10000
  key-value-write = 10000

  io-queue-size = 10000
  io-normal-window = 10s

  metadata-write = 100000

  memory-threshold-in-mb = 1024
  memory-measurement-window = 6
}
